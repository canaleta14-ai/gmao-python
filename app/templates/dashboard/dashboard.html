<!-- {% extends 'base.html' %} {% block section_title %}Dashboard{% endblock %} {%
set section = 'dashboard' %} {% block content %}
<!-- Estad√≠sticas R√°pidas -->
<div class="row mb-4">
  <div class="col-12 mb-3">
    <h5 class="mb-1"><i class="bi bi-speedometer2 me-2"></i> Dashboard</h5>
    <small class="text-muted"
      >Bienvenido al panel de control. Aqu√≠ puedes ver un resumen de las
      m√©tricas clave.</small
    >
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card primary">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-primary bg-opacity-10 text-primary me-3">
            <i class="bi bi-wrench"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">√ìrdenes Activas</h6>
            <h3 class="mb-0" id="stat-ordenes-activas">0</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card success">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-success bg-opacity-10 text-success me-3">
            <i class="bi bi-check-circle"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Completadas Hoy</h6>
            <h3 class="mb-0" id="stat-completadas">0</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card warning">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-warning bg-opacity-10 text-warning me-3">
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Pendientes</h6>
            <h3 class="mb-0" id="stat-pendientes">0</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card stats-card info">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-info bg-opacity-10 text-info me-3">
            <i class="bi bi-cpu"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Total Activos</h6>
            <h3 class="mb-0" id="stat-activos">0</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- √ìrdenes Recientes -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
        style="background: var(--primary-color); color: #fff"
      >
        <h6 class="mb-0">
          <i class="bi bi-clipboard-check me-2"></i> √ìrdenes Recientes
          <span class="badge bg-warning ms-2" id="contador-ordenes-recientes"
            >0</span
          >
        </h6>
        <a class="btn btn-sm btn-outline-light" href="/ordenes">Ver Todas</a>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th><i class="bi bi-hash me-1"></i>ID</th>
                <th><i class="bi bi-cpu me-1"></i>Equipo</th>
                <th><i class="bi bi-gear me-1"></i>Tipo</th>
                <th>
                  <i class="bi bi-exclamation-triangle me-1"></i>Prioridad
                </th>
                <th><i class="bi bi-circle me-1"></i>Estado</th>
                <th><i class="bi bi-person me-1"></i>T√©cnico</th>
                <th class="text-center">
                  <i class="bi bi-three-dots me-1"></i>Acciones
                </th>
              </tr>
            </thead>
            <tbody id="ordenes-recientes-tbody">
              <!-- Se llenar√° din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Funci√≥n para cargar √≥rdenes recientes
  function loadOrdenesRecientes() {
    console.log("üìã Cargando √≥rdenes recientes...");

    const tbody = document.getElementById("ordenes-recientes-tbody");
    const contador = document.getElementById("contador-ordenes-recientes");

    if (!tbody) {
      console.error("‚ùå Elemento ordenes-recientes-tbody no encontrado");
      return;
    }

    // Mostrar loading
    tbody.innerHTML =
      '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Cargando √≥rdenes recientes...</td></tr>';

    fetch("/ordenes/api?limit=5")
      .then((response) => {
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Usuario no autenticado");
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("üìã √ìrdenes recientes recibidas:", data);

        if (data.ordenes && data.ordenes.length > 0) {
          let html = "";
          data.ordenes.forEach((orden) => {
            const estadoClass = getEstadoClass(orden.estado);
            const prioridadClass = getPrioridadClass(orden.prioridad);

            html += `
                        <tr>
                            <td><strong>${
                              orden.numero_orden || orden.id
                            }</strong></td>
                            <td>${orden.activo?.nombre || "N/A"}</td>
                            <td><span class="badge bg-secondary">${
                              orden.tipo
                            }</span></td>
                            <td><span class="badge ${prioridadClass}">${
              orden.prioridad
            }</span></td>
                            <td><span class="badge ${estadoClass}">${
              orden.estado
            }</span></td>
                            <td>${orden.tecnico?.nombre || "Sin asignar"}</td>
                            <td class="text-center">
                                <a href="/ordenes/${
                                  orden.id
                                }" class="btn btn-sm btn-outline-primary" aria-label="Ver detalles de la orden">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `;
          });

          tbody.innerHTML = html;

          // Actualizar contador
          if (contador) {
            contador.textContent = data.ordenes.length;
          }

          console.log("‚úÖ √ìrdenes recientes cargadas exitosamente");
        } else {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">No hay √≥rdenes recientes</td></tr>';
          if (contador) {
            contador.textContent = "0";
          }
        }
      })
      .catch((error) => {
        console.error("‚ùå Error cargando √≥rdenes recientes:", error);
        if (error.message.includes("Usuario no autenticado")) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-warning">Debe iniciar sesi√≥n para ver las √≥rdenes</td></tr>';
        } else {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-danger">Error al cargar √≥rdenes recientes</td></tr>';
        }
        if (contador) {
          contador.textContent = "0";
        }
      });
  }

  // Funciones auxiliares para clases de estado y prioridad
  function getEstadoClass(estado) {
    switch (estado?.toLowerCase()) {
      case "completada":
        return "bg-success";
      case "en proceso":
        return "bg-primary";
      case "pendiente":
        return "bg-warning";
      case "iniciada":
        return "bg-info";
      case "cancelada":
        return "bg-danger";
      default:
        return "bg-secondary";
    }
  }

  function getPrioridadClass(prioridad) {
    switch (prioridad?.toLowerCase()) {
      case "alta":
        return "bg-danger";
      case "media":
        return "bg-warning";
      case "baja":
        return "bg-success";
      default:
        return "bg-secondary";
    }
  }

  // ¬°SOLUCION DIRECTA! - Funci√≥n loadDashboard corregida
  function loadDashboardFixed() {
    console.log("üöÄ DASHBOARD CORREGIDO - Cargando componentes...");

    // Cargar √≥rdenes recientes
    loadOrdenesRecientes();

    // Cargar estad√≠sticas - ESTA ES LA PARTE IMPORTANTE
    console.log("üìä Iniciando carga de estad√≠sticas...");
    const statsStart = performance.now();

    fetch("/api/estadisticas")
      .then((response) => {
        const statsTime = performance.now() - statsStart;
        console.log(
          `üìä Respuesta en ${statsTime.toFixed(2)}ms - Status: ${
            response.status
          }`
        );

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Usuario no autenticado");
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("üéâ Datos recibidos exitosamente:", data);

        // Calcular √≥rdenes activas (todas menos las completadas)
        const completadas = data.ordenes_por_estado["Completada"] || 0;
        const pendientes = data.ordenes_por_estado["Pendiente"] || 0;
        const enProceso = data.ordenes_por_estado["En Proceso"] || 0;
        const iniciadas = data.ordenes_por_estado["Iniciada"] || 0;

        // √ìrdenes activas = todas las que no est√°n completadas
        const activas = pendientes + enProceso + iniciadas;

        console.log(
          `üìà Valores calculados: activas=${activas}, completadas=${completadas}, pendientes=${pendientes}, activos=${data.total_activos}`
        );

        // Actualizar elementos directamente (sin animaci√≥n por ahora para debug)
        const elementActivas = document.getElementById("stat-ordenes-activas");
        const elementCompletadas = document.getElementById("stat-completadas");
        const elementPendientes = document.getElementById("stat-pendientes");
        const elementActivos = document.getElementById("stat-activos");

        if (elementActivas) {
          elementActivas.textContent = activas;
          console.log("‚úÖ stat-ordenes-activas actualizado a:", activas);
        } else {
          console.error("‚ùå elemento stat-ordenes-activas no encontrado");
        }

        if (elementCompletadas) {
          elementCompletadas.textContent = completadas;
          console.log("‚úÖ stat-completadas actualizado a:", completadas);
        } else {
          console.error("‚ùå elemento stat-completadas no encontrado");
        }

        if (elementPendientes) {
          elementPendientes.textContent = pendientes;
          console.log("‚úÖ stat-pendientes actualizado a:", pendientes);
        } else {
          console.error("‚ùå elemento stat-pendientes no encontrado");
        }

        if (elementActivos) {
          elementActivos.textContent = data.total_activos || 0;
          console.log("‚úÖ stat-activos actualizado a:", data.total_activos);
        } else {
          console.error("‚ùå elemento stat-activos no encontrado");
        }

        console.log("üéâ ¬°Dashboard actualizado exitosamente!");
      })
      .catch((error) => {
        const statsTime = performance.now() - statsStart;
        console.error(`‚ùå Error despu√©s de ${statsTime.toFixed(2)}ms:`, error);

        // Mostrar mensaje de error al usuario
        if (error.message.includes("Usuario no autenticado")) {
          console.warn("‚ö†Ô∏è Usuario no autenticado, mostrando mensaje...");
          // Podr√≠amos mostrar un mensaje al usuario aqu√≠
        }
      });
  }

  // Ejecutar cuando el DOM est√© listo
  document.addEventListener("DOMContentLoaded", function () {
    console.log("üìä Dashboard template loaded, calling loadDashboardFixed()");
    // Peque√±o delay para asegurar que la sesi√≥n est√© establecida
    setTimeout(() => {
      loadDashboardFixed();
    }, 500);
  });
</script>
{% endblock %} -->
