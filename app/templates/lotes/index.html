{% extends "base.html" %}
{% set active_page = "lotes" %}

{% block title %}Sistema FIFO - Gestión de Lotes{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
}

.feature-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    overflow: hidden;
    height: 100%;
    background: white;
    display: flex;
    flex-direction: column;
}

.feature-card .card-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 30px 25px;
}

.feature-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

.feature-icon {
    font-size: 3.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
    min-height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feature-card:hover .feature-icon {
    transform: scale(1.1);
}

.feature-card .card-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    min-height: 35px;
    display: flex;
    align-items: center;
}

.feature-card .card-text {
    font-size: 0.95rem;
    line-height: 1.6;
    color: #718096;
    margin-bottom: 1.5rem;
    flex: 1;
    min-height: 90px;
}

.feature-card .actions-container {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.feature-card .form-control {
    height: 42px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

.feature-card .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
}

.feature-card .btn {
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.95rem;
}

.feature-card .btn i {
    margin-right: 6px;
}

.quick-stats {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.stat-item {
    text-align: center;
    padding: 15px;
    border-right: 2px solid rgba(255, 255, 255, 0.5);
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: scale(1.05);
}

.stat-item:last-child {
    border-right: none;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2d3748;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.stat-item:hover .stat-number {
    color: #667eea;
}

.stat-label {
    color: #4a5568;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.alert-count {
    background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
    color: white;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 8px;
    box-shadow: 0 2px 8px rgba(245, 101, 101, 0.4);
    animation: pulse 2s infinite;
    display: inline-block;
    vertical-align: middle;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Estilos específicos para botones dentro de tarjetas */
.btn-block {
    width: 100%;
}

.btn.w-100 {
    width: 100% !important;
}

/* Botones outline con borde púrpura - Actualizado 2025 */
.btn-outline-primary {
    background: transparent !important;
    border: 2px solid #667eea !important;
    color: #667eea !important;
    transition: all 0.3s ease;
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border-color: #667eea !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* Asegurar alineación de inputs */
input.form-control::placeholder {
    color: #a0aec0;
    font-size: 0.9rem;
}

/* Panel de información de vencimientos */
.vencimientos-info {
    background: #f7fafc;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #e2e8f0;
}

.vencimientos-info .d-flex {
    align-items: center;
}

.vencimientos-info i {
    margin-right: 6px;
}

.vencimientos-info strong {
    font-size: 1.1rem;
    font-weight: 700;
}

.card-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
}

.card-text {
    font-size: 0.95rem;
    line-height: 1.6;
}

/* Contenedor uniforme de acciones */
.actions-container {
    margin-top: auto;
    padding-top: 1rem;
}

.actions-container > * {
    margin-bottom: 10px;
}

.actions-container > *:last-child {
    margin-bottom: 0;
}

/* Botones uniformes */
.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    padding: 10px 16px;
    font-size: 0.95rem;
    border: none;
}

.btn i {
    margin-right: 6px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    border: none;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    border: none;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    border: none;
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
}

.btn-light {
    background: white;
    color: #667eea;
    border: 2px solid white;
    font-weight: 600;
}

.btn-light:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 255, 255, 0.5);
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Mejoras para tablas */
.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
    transition: all 0.3s ease;
}

/* Loading animation */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Media queries para responsividad */
@media (max-width: 1199px) {
    .feature-card .card-text {
        min-height: 100px;
    }
}

@media (max-width: 991px) {
    .feature-card .card-text {
        min-height: 80px;
    }
    
    .feature-icon {
        font-size: 3rem;
        min-height: 60px;
    }
}

@media (max-width: 767px) {
    .feature-card .card-text {
        min-height: auto;
    }
    
    .feature-card .card-title {
        min-height: auto;
    }
    
    .feature-icon {
        min-height: auto;
    }
    
    .stat-item {
        border-right: none !important;
        border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    
    .stat-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
}

/* Mejoras de accesibilidad */
.btn:focus,
.form-control:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* Transiciones suaves para todos los elementos interactivos */
a, button, input, .card {
    transition: all 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado Principal -->
    <div class="dashboard-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-boxes"></i>
                    Sistema FIFO - Gestión de Lotes
                </h1>
                <p class="mb-0">
                    Control de inventario con trazabilidad completa siguiendo la metodología 
                    First In, First Out (FIFO) para garantizar la rotación adecuada de productos.
                </p>
            </div>
            <div class="col-md-4 text-md-right">
                <a href="{{ url_for('lotes.crear_lote') }}" class="btn btn-light btn-lg">
                    <i class="fas fa-plus"></i> Crear Nuevo Lote
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="quick-stats">
        <div class="row" id="estadisticas-rapidas">
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="total-lotes">-</div>
                <div class="stat-label">Lotes Activos</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="articulos-fifo">-</div>
                <div class="stat-label">Artículos con FIFO</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number text-warning" id="proximos-vencer">-</div>
                <div class="stat-label">Próximos a Vencer</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number text-danger" id="vencidos">-</div>
                <div class="stat-label">Lotes Vencidos</div>
            </div>
        </div>
    </div>

    <!-- Funcionalidades Principales -->
    <div class="row">
        <!-- Buscar Artículos -->
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h5 class="card-title">Buscar Artículos</h5>
                    <p class="card-text">
                        Busque cualquier artículo y vea sus lotes disponibles, 
                        stock actual y próximas fechas de vencimiento.
                    </p>
                    <div class="actions-container">
                        <input type="text" class="form-control" 
                               id="buscar-articulo" 
                               placeholder="Código o nombre del artículo">
                        <button class="btn btn-primary w-100" onclick="buscarArticulo()">
                            <i class="fas fa-search"></i> Buscar Artículo
                        </button>
                        <a href="/inventario/" class="btn btn-outline-primary w-100">
                            <i class="fas fa-list"></i> Ver Inventario
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Lotes -->
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <h5 class="card-title">Gestión de Lotes</h5>
                    <p class="card-text">
                        Cree nuevos lotes de entrada, consulte existencias 
                        y gestione el inventario siguiendo la metodología FIFO.
                    </p>
                    <div class="actions-container">
                        <a href="{{ url_for('lotes.crear_lote') }}" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> Crear Lote
                        </a>
                        <button class="btn btn-outline-primary w-100" onclick="verLotesActivos()">
                            <i class="fas fa-list"></i> Ver Lotes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trazabilidad -->
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <h5 class="card-title">Trazabilidad</h5>
                    <p class="card-text">
                        Siga el recorrido completo de cualquier lote desde 
                        su entrada hasta su consumo final.
                    </p>
                    <div class="actions-container">
                        <input type="text" class="form-control" 
                               id="buscar-lote" 
                               placeholder="ID o código de lote">
                        <button class="btn btn-info w-100" onclick="buscarLote()">
                            <i class="fas fa-search"></i> Buscar Lote
                        </button>
                        <a href="{{ url_for('lotes.trazabilidad') }}" class="btn btn-outline-primary w-100" data-style="outline">
                            <i class="fas fa-route"></i> Ver Todas
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vencimientos -->
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                    </div>
                    <h5 class="card-title">
                        Control de Vencimientos
                        <span class="alert-count" id="vencimientos-badge">0</span>
                    </h5>
                    <p class="card-text">
                        Monitoree productos próximos a vencer y gestione 
                        las rotaciones de inventario proactivamente.
                    </p>
                    <div class="actions-container">
                        <div class="vencimientos-info mb-3">
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="fas fa-clock"></i> Próximos 30 días</span>
                                <strong id="proximos-vencer-mini">0</strong>
                            </div>
                            <div class="d-flex justify-content-between text-danger small mt-1">
                                <span><i class="fas fa-times-circle"></i> Ya vencidos</span>
                                <strong id="vencidos-mini">0</strong>
                            </div>
                        </div>
                        <a href="{{ url_for('lotes.vencimientos') }}" class="btn btn-warning w-100">
                            <i class="fas fa-calendar-exclamation"></i> Ver Vencimientos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Resultados de Búsqueda -->
    <div class="row" id="resultados-busqueda" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Resultados de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-resultados">
                            <thead class="thead-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Stock Disponible</th>
                                    <th>Lotes Activos</th>
                                    <th>Próximo Vencimiento</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-resultados">
                                <!-- Resultados dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Lotes Activos -->
    <div class="row" id="tabla-lotes-activos" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes"></i> Lotes Activos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-lotes">
                            <thead class="thead-light">
                                <tr>
                                    <th>ID Lote</th>
                                    <th>Código Lote</th>
                                    <th>Artículo</th>
                                    <th>Cantidad Actual</th>
                                    <th>Fecha Entrada</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-lotes">
                                <!-- Lotes dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let articulosDisponibles = [];
let lotesActivos = [];

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    cargarEstadisticasRapidas();
    cargarArticulosDisponibles();
    
    // Configurar búsqueda en tiempo real
    const buscarArticuloInput = document.getElementById('buscar-articulo');
    if (buscarArticuloInput) {
        buscarArticuloInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) { // Enter
                buscarArticulo();
            }
        });
    }
    
    const buscarLoteInput = document.getElementById('buscar-lote');
    if (buscarLoteInput) {
        buscarLoteInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) { // Enter
                buscarLote();
            }
        });
    }
});

// Cargar estadísticas rápidas
function cargarEstadisticasRapidas() {
    // Mostrar indicador de carga
    const elementos = ['total-lotes', 'articulos-fifo', 'proximos-vencer', 'vencidos'];
    elementos.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    });
    
    // Cargar datos reales desde el API
    fetch('/lotes/api/estadisticas')
        .then(response => response.json())
        .then(response => {
            if (response.success && response.estadisticas) {
                const stats = response.estadisticas;
                
                // Actualizar valores con animación
                animateValue('total-lotes', 0, stats.total_lotes, 800);
                animateValue('articulos-fifo', 0, stats.articulos_fifo, 800);
                animateValue('proximos-vencer', 0, stats.proximos_vencer, 800);
                animateValue('vencidos', 0, stats.vencidos, 800);
                
                // Actualizar badge de vencimientos
                const totalVencimientos = stats.proximos_vencer + stats.vencidos;
                const badge = document.getElementById('vencimientos-badge');
                if (badge) badge.textContent = totalVencimientos;
                
                // Actualizar mini-contadores en la tarjeta de vencimientos
                const proximosMini = document.getElementById('proximos-vencer-mini');
                const vencidosMini = document.getElementById('vencidos-mini');
                if (proximosMini) proximosMini.textContent = stats.proximos_vencer;
                if (vencidosMini) vencidosMini.textContent = stats.vencidos;
                
                console.log('✅ Estadísticas FIFO cargadas:', stats);
            } else {
                mostrarErrorEstadisticas();
            }
        })
        .catch(error => {
            console.error('❌ Error al cargar estadísticas:', error);
            mostrarErrorEstadisticas();
        });
}

// Función auxiliar para animar números
function animateValue(id, start, end, duration) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const range = end - start;
    const increment = range / (duration / 16); // ~60fps
    let current = start;
    
    const timer = setInterval(function() {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 16);
}

// Mostrar error en estadísticas
function mostrarErrorEstadisticas() {
    const elementos = {
        'total-lotes': '0',
        'articulos-fifo': '0',
        'proximos-vencer': '0',
        'vencidos': '0',
        'vencimientos-badge': '0'
    };
    
    Object.keys(elementos).forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = elementos[id];
    });
}

// Cargar artículos disponibles para autocompletado
function cargarArticulosDisponibles() {
    fetch('/api/inventario/activos')
        .then(response => response.json())
        .then(data => {
            articulosDisponibles = data.articulos || [];
            console.log('✅ Artículos disponibles cargados:', articulosDisponibles.length);
        })
        .catch(error => {
            console.log('⚠️ Error al cargar artículos disponibles:', error);
        });
}

// Buscar artículo
function buscarArticulo() {
    const inputElem = document.getElementById('buscar-articulo');
    const termino = inputElem ? inputElem.value.trim() : '';
    
    if (!termino) {
        mostrarMensaje('Por favor ingrese un término de búsqueda', 'warning');
        return;
    }

    // Mostrar loading
    const resultadosDiv = document.getElementById('resultados-busqueda');
    const tbodyResultados = document.getElementById('tbody-resultados');
    
    if (resultadosDiv) resultadosDiv.style.display = 'block';
    if (tbodyResultados) {
        tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</td></tr>';
    }

    // Buscar en artículos locales primero
    const resultadosLocales = articulosDisponibles.filter(art => 
        art.codigo.toLowerCase().includes(termino.toLowerCase()) ||
        (art.nombre && art.nombre.toLowerCase().includes(termino.toLowerCase()))
    );
    
    if (resultadosLocales.length === 1) {
        // Si hay exactamente un resultado, ir directamente a su página
        window.location.href = `/lotes/inventario/${resultadosLocales[0].id}`;
    } else if (resultadosLocales.length > 1) {
        // Mostrar múltiples resultados
        mostrarResultadosBusqueda(resultadosLocales);
    } else {
        // Búsqueda en servidor
        fetch(`/api/inventario/buscar?q=${encodeURIComponent(termino)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.articulos && data.articulos.length > 0) {
                    mostrarResultadosBusqueda(data.articulos);
                } else {
                    if (tbodyResultados) {
                        tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No se encontraron artículos</td></tr>';
                    }
                }
            })
            .catch(error => {
                console.error('Error en búsqueda:', error);
                if (tbodyResultados) {
                    tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al realizar la búsqueda</td></tr>';
                }
            });
    }
}

// Mostrar resultados de búsqueda
function mostrarResultadosBusqueda(articulos) {
    let html = '';
    
    articulos.forEach(function(articulo) {
        const stockDisponible = articulo.stock_disponible || 0;
        const lotesActivos = articulo.lotes_activos || 0;
        const proximoVencimiento = articulo.proximo_vencimiento || 'N/A';
        
        html += `
            <tr>
                <td><strong>${articulo.codigo}</strong></td>
                <td>${articulo.nombre || ''}</td>
                <td>
                    <span class="badge badge-${stockDisponible > 0 ? 'success' : 'danger'}">
                        ${stockDisponible} ${articulo.unidad_medida || 'UN'}
                    </span>
                </td>
                <td>${lotesActivos}</td>
                <td>${proximoVencimiento}</td>
                <td>
                    <a href="/lotes/inventario/${articulo.id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Ver Lotes
                    </a>
                </td>
            </tr>
        `;
    });
    
    const tbody = document.getElementById('tbody-resultados');
    if (tbody) tbody.innerHTML = html;
}

// Ver lotes activos
function verLotesActivos() {
    const tablaLotesDiv = document.getElementById('tabla-lotes-activos');
    const tbodyLotes = document.getElementById('tbody-lotes');
    
    if (tablaLotesDiv) tablaLotesDiv.style.display = 'block';
    if (tbodyLotes) {
        tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando lotes...</td></tr>';
    }
    
    fetch('/api/lotes/activos')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.lotes && data.lotes.length > 0) {
                mostrarLotesActivos(data.lotes);
            } else {
                if (tbodyLotes) {
                    tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay lotes activos</td></tr>';
                }
            }
        })
        .catch(error => {
            console.error('Error al cargar lotes:', error);
            if (tbodyLotes) {
                tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar lotes</td></tr>';
            }
        });
}

// Mostrar lotes activos
function mostrarLotesActivos(lotes) {
    let html = '';
    
    lotes.forEach(function(lote) {
        const fechaVencimiento = lote.fecha_vencimiento ? 
            new Date(lote.fecha_vencimiento).toLocaleDateString() : 'N/A';
        const fechaEntrada = new Date(lote.fecha_entrada).toLocaleDateString();
        
        // Determinar estado del lote
        let estadoBadge = 'badge-success';
        let estadoTexto = 'Activo';
        
        if (lote.fecha_vencimiento) {
            const hoy = new Date();
            const vencimiento = new Date(lote.fecha_vencimiento);
            const diasRestantes = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
            
            if (diasRestantes < 0) {
                estadoBadge = 'badge-danger';
                estadoTexto = 'Vencido';
            } else if (diasRestantes <= 30) {
                estadoBadge = 'badge-warning';
                estadoTexto = 'Por vencer';
            }
        }
        
        html += `
            <tr>
                <td><strong>${lote.id}</strong></td>
                <td>${lote.codigo_lote || 'Auto-' + lote.id}</td>
                <td>
                    <div><strong>${lote.inventario_codigo}</strong></div>
                    <small class="text-muted">${lote.inventario_nombre}</small>
                </td>
                <td>${lote.cantidad_actual} ${lote.unidad_medida || 'UN'}</td>
                <td>${fechaEntrada}</td>
                <td>${fechaVencimiento}</td>
                <td>
                    <span class="badge ${estadoBadge}">${estadoTexto}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="/lotes/inventario/${lote.inventario_id}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="verTrazabilidad(${lote.id})">
                            <i class="fas fa-route"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    const tbody = document.getElementById('tbody-lotes');
    if (tbody) tbody.innerHTML = html;
}

// Buscar lote específico
function buscarLote() {
    const inputElem = document.getElementById('buscar-lote');
    const loteId = inputElem ? inputElem.value.trim() : '';
    
    if (!loteId) {
        mostrarMensaje('Por favor ingrese un ID de lote', 'warning');
        return;
    }
    
    verTrazabilidad(loteId);
}

// Ver trazabilidad de un lote
function verTrazabilidad(loteId) {
    window.location.href = `/lotes/trazabilidad?lote=${loteId}`;
}

// Función auxiliar para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    const tipoClase = tipo === 'error' ? 'danger' : tipo;
    const html = `
        <div class="alert alert-${tipoClase} alert-dismissible fade show">
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insertar al inicio del contenido
    const container = document.querySelector('.container-fluid');
    if (container) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        container.insertBefore(tempDiv.firstElementChild, container.firstChild);
        
        // Auto-ocultar después de 5 segundos
        setTimeout(function() {
            const alerts = container.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);
    }
}
</script>
{% endblock %}