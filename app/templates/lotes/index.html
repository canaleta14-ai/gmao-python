{% extends "base.html" %}
{% set active_page = "lotes" %}

{% block title %}Sistema FIFO - Gestión de Lotes{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.35);
}

.feature-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    overflow: hidden;
    height: 100%;
    background: white;
    display: flex;
    flex-direction: column;
}

.feature-card .card-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 12px 12px;
}

.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.feature-icon {
    font-size: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
    min-height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feature-card:hover .feature-icon {
    transform: scale(1.05);
}

.feature-card .card-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    min-height: 24px;
    display: flex;
    align-items: center;
}

.feature-card .card-text {
    font-size: 0.8rem;
    line-height: 1.4;
    color: #718096;
    margin-bottom: 0.75rem;
    flex: 1;
    min-height: 45px;
}

.feature-card .actions-container {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.feature-card .form-control {
    height: 32px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.feature-card .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.15rem rgba(102, 126, 234, 0.12);
}

.feature-card .btn {
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.feature-card .btn i {
    margin-right: 4px;
    font-size: 0.8rem;
}

.quick-stats {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.stat-item {
    text-align: center;
    padding: 15px;
    border-right: 2px solid rgba(255, 255, 255, 0.5);
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: scale(1.05);
}

.stat-item:last-child {
    border-right: none;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2d3748;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.stat-item:hover .stat-number {
    color: #667eea;
}

.stat-label {
    color: #4a5568;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.alert-count {
    background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
    color: white;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 8px;
    box-shadow: 0 2px 8px rgba(245, 101, 101, 0.4);
    animation: pulse 2s infinite;
    display: inline-block;
    vertical-align: middle;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Estilos específicos para botones dentro de tarjetas */
.btn-block {
    width: 100%;
}

.btn.w-100 {
    width: 100% !important;
}

/* Botones outline con borde púrpura - Actualizado 2025 */
.btn-outline-primary {
    background: transparent !important;
    border: 2px solid #667eea !important;
    color: #667eea !important;
    transition: all 0.3s ease;
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border-color: #667eea !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* Asegurar alineación de inputs */
input.form-control::placeholder {
    color: #a0aec0;
    font-size: 0.9rem;
}

/* Panel de información de vencimientos */
.vencimientos-info {
    background: #f7fafc;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #e2e8f0;
}

.vencimientos-info .d-flex {
    align-items: center;
}

.vencimientos-info i {
    margin-right: 6px;
}

.vencimientos-info strong {
    font-size: 1.1rem;
    font-weight: 700;
}

.card-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1rem;
}

.card-text {
    font-size: 0.95rem;
    line-height: 1.6;
}

/* Contenedor uniforme de acciones */
.actions-container {
    margin-top: auto;
    padding-top: 1rem;
}

.actions-container > * {
    margin-bottom: 10px;
}

.actions-container > *:last-child {
    margin-bottom: 0;
}

/* Botones uniformes */
.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    padding: 10px 16px;
    font-size: 0.95rem;
    border: none;
}

.btn i {
    margin-right: 6px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    border: none;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    border: none;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    border: none;
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
}

.btn-light {
    background: white;
    color: #667eea;
    border: 2px solid white;
    font-weight: 600;
}

.btn-light:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 255, 255, 0.5);
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Mejoras para tablas */
.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
    transition: all 0.3s ease;
}

/* Loading animation */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Media queries para responsividad */
@media (max-width: 1199px) {
    .feature-card .card-text {
        min-height: 100px;
    }
}

@media (max-width: 991px) {
    .feature-card .card-text {
        min-height: 80px;
    }
    
    .feature-icon {
        font-size: 3rem;
        min-height: 60px;
    }
}

@media (max-width: 767px) {
    .feature-card .card-text {
        min-height: auto;
    }
    
    .feature-card .card-title {
        min-height: auto;
    }
    
    .feature-icon {
        min-height: auto;
    }
    
    .stat-item {
        border-right: none !important;
        border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    
    .stat-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
}

/* Mejoras de accesibilidad */
.btn:focus,
.form-control:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* Transiciones suaves para todos los elementos interactivos */
a, button, input, .card {
    transition: all 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado Principal -->
    <div class="dashboard-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-boxes"></i>
                    Sistema FIFO - Gestión de Lotes
                </h1>
                <p class="mb-0">
                    Control de inventario con trazabilidad completa siguiendo la metodología 
                    First In, First Out (FIFO) para garantizar la rotación adecuada de productos.
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('lotes.crear_lote') }}" class="btn btn-light btn-lg">
                    <i class="fas fa-plus"></i> Crear Nuevo Lote
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="quick-stats">
        <div class="row" id="estadisticas-rapidas">
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="total-lotes">-</div>
                <div class="stat-label">Lotes Activos</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="articulos-fifo">-</div>
                <div class="stat-label">Artículos con FIFO</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number text-warning" id="proximos-vencer">-</div>
                <div class="stat-label">Próximos a Vencer</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number text-danger" id="vencidos">-</div>
                <div class="stat-label">Lotes Vencidos</div>
            </div>
        </div>
    </div>

    <!-- Funcionalidades Principales -->
    <div class="row">
        <!-- Buscar Artículos -->
        <div class="col-md-6 col-xl-3 mb-2">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h5 class="card-title">Buscar Artículos</h5>
                    <p class="card-text">
                        Busque cualquier artículo y vea sus lotes disponibles, 
                        stock actual y próximas fechas de vencimiento.
                    </p>
                    <div class="actions-container">
                        <input type="text" class="form-control" 
                               id="buscar-articulo" 
                               list="articulos-list"
                               placeholder="Código o nombre del artículo"
                               autocomplete="off">
                        <datalist id="articulos-list"></datalist>
                        <button class="btn btn-primary w-100" onclick="buscarArticulo()">
                            <i class="fas fa-search"></i> Buscar Artículo
                        </button>
                        <a href="/inventario/" class="btn btn-outline-primary w-100">
                            <i class="fas fa-list"></i> Ver Inventario
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Lotes -->
        <div class="col-md-6 col-xl-3 mb-2">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <h5 class="card-title">Gestión de Lotes</h5>
                    <p class="card-text">
                        Cree nuevos lotes de entrada, consulte existencias 
                        y gestione el inventario siguiendo la metodología FIFO.
                    </p>
                    <div class="actions-container">
                        <a href="{{ url_for('lotes.crear_lote') }}" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> Crear Lote
                        </a>
                        <button class="btn btn-outline-primary w-100" onclick="verLotesActivos()">
                            <i class="fas fa-list"></i> Ver Lotes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trazabilidad -->
        <div class="col-md-6 col-xl-3 mb-2">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <h5 class="card-title">Trazabilidad</h5>
                    <p class="card-text">
                        Siga el recorrido completo de cualquier lote desde 
                        su entrada hasta su consumo final.
                    </p>
                    <div class="actions-container">
                        <input type="text" class="form-control" 
                               id="buscar-lote" 
                               list="lotes-list"
                               placeholder="ID o código de lote"
                               autocomplete="off">
                        <datalist id="lotes-list"></datalist>
                        <button class="btn btn-info w-100" onclick="buscarLote()">
                            <i class="fas fa-search"></i> Buscar Lote
                        </button>
                        <a href="{{ url_for('lotes.trazabilidad') }}" class="btn btn-outline-primary w-100" data-style="outline">
                            <i class="fas fa-route"></i> Ver Todas
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vencimientos -->
        <div class="col-md-6 col-xl-3 mb-2">
            <div class="card feature-card">
                <div class="card-body">
                    <div class="feature-icon">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                    </div>
                    <h5 class="card-title">
                        Control de Vencimientos
                        <span class="alert-count" id="vencimientos-badge">0</span>
                    </h5>
                    <p class="card-text">
                        Monitoree productos próximos a vencer y gestione 
                        las rotaciones de inventario proactivamente.
                    </p>
                    <div class="actions-container">
                        <div class="vencimientos-info mb-3">
                            <div class="d-flex justify-content-between text-muted small">
                                <span><i class="fas fa-clock"></i> Próximos 30 días</span>
                                <strong id="proximos-vencer-mini">0</strong>
                            </div>
                            <div class="d-flex justify-content-between text-danger small mt-1">
                                <span><i class="fas fa-times-circle"></i> Ya vencidos</span>
                                <strong id="vencidos-mini">0</strong>
                            </div>
                        </div>
                        <a href="{{ url_for('lotes.vencimientos') }}" class="btn btn-warning w-100">
                            <i class="fas fa-calendar-exclamation"></i> Ver Vencimientos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Resultados de Búsqueda -->
    <div class="row" id="resultados-busqueda" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Resultados de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabla-resultados">
                            <thead class="thead-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Stock Disponible</th>
                                    <th>Lotes Activos</th>
                                    <th>Próximo Vencimiento</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-resultados">
                                <!-- Resultados dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Filtros de Lotes -->
    <div class="row mt-4" id="filtros-lotes-activos" style="display: none;">
        <div class="col-12">
            <div class="filtros-container">
                <div class="filtros-header" data-bs-toggle="collapse" data-bs-target="#filtrosLotes">
                    <h6>Filtros de Búsqueda</h6>
                    <i class="bi bi-chevron-down filtros-toggle-icon"></i>
                </div>
                <div id="filtrosLotes" class="collapse">
                    <div class="filtros-body">
                        <form id="filtros-form-lotes" class="row g-3 p-3">
                            <div class="col-lg-3 col-md-6">
                                <label for="filtro-articulo" class="form-label fw-bold">Artículo</label>
                                <select id="filtro-articulo" class="form-select">
                                    <option value="">Todos los artículos</option>
                                </select>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="filtro-codigo-lote" class="form-label fw-bold">Código de Lote</label>
                                <input type="text" class="form-control" id="filtro-codigo-lote" placeholder="Buscar por código...">
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="filtro-fecha-entrada-desde" class="form-label fw-bold">Fecha Entrada Desde</label>
                                <input type="date" class="form-control" id="filtro-fecha-entrada-desde">
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="filtro-fecha-entrada-hasta" class="form-label fw-bold">Fecha Entrada Hasta</label>
                                <input type="date" class="form-control" id="filtro-fecha-entrada-hasta">
                            </div>

                            <div class="col-12">
                                <hr class="mb-3">
                                <div class="d-flex gap-2 flex-wrap align-items-center">
                                    <button type="button" class="btn btn-primary" onclick="aplicarFiltrosLotes()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltrosLotes()">
                                        <i class="bi bi-x-circle me-1"></i>Limpiar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Lotes Activos -->
    <div class="row mt-3" id="tabla-lotes-activos" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-table me-2"></i>Listado de Lotes Activos</h6>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span id="info-registros" class="text-white-50 small">0 lotes</span>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="ocultarLotesActivos()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-even" id="tabla-lotes">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 8%;">ID</th>
                                    <th style="width: 12%;"><i class="bi bi-upc-scan me-1"></i>Código Lote</th>
                                    <th style="width: 25%;"><i class="bi bi-box me-1"></i>Artículo</th>
                                    <th style="width: 10%;"><i class="bi bi-stack me-1"></i>Disponible</th>
                                    <th style="width: 10%;"><i class="bi bi-calendar-check me-1"></i>F. Entrada</th>
                                    <th style="width: 10%;"><i class="bi bi-calendar-x me-1"></i>F. Vencimiento</th>
                                    <th style="width: 10%;"><i class="bi bi-circle me-1"></i>Estado</th>
                                    <th class="text-center" style="width: 15%;"><i class="bi bi-gear me-1"></i>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-lotes">
                                <!-- Lotes dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Paginación -->
                <nav aria-label="Paginación de lotes" class="m-2">
                    <div id="paginacion-lotes"></div>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let articulosDisponibles = [];
let lotesActivos = [];
let paginaActualLotes = 1;
let porPaginaLotes = 10;
let paginacionInfo = {};

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    cargarEstadisticasRapidas();
    cargarArticulosDisponibles();
    
    // Configurar búsqueda en tiempo real con autocompletado
    const buscarArticuloInput = document.getElementById('buscar-articulo');
    if (buscarArticuloInput) {
        buscarArticuloInput.addEventListener('input', function(e) {
            actualizarSugerenciasArticulos(this.value);
        });
        buscarArticuloInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) { // Enter
                buscarArticulo();
            }
        });
    }
    
    const buscarLoteInput = document.getElementById('buscar-lote');
    if (buscarLoteInput) {
        buscarLoteInput.addEventListener('input', function(e) {
            actualizarSugerenciasLotes(this.value);
        });
        buscarLoteInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) { // Enter
                buscarLote();
            }
        });
    }
});

// Cargar estadísticas rápidas
function cargarEstadisticasRapidas() {
    // Mostrar indicador de carga
    const elementos = ['total-lotes', 'articulos-fifo', 'proximos-vencer', 'vencidos'];
    elementos.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    });
    
    // Cargar datos reales desde el API
    fetch('/lotes/api/estadisticas')
        .then(response => response.json())
        .then(response => {
            if (response.success && response.estadisticas) {
                const stats = response.estadisticas;
                
                // Actualizar valores con animación
                animateValue('total-lotes', 0, stats.total_lotes, 800);
                animateValue('articulos-fifo', 0, stats.articulos_fifo, 800);
                animateValue('proximos-vencer', 0, stats.proximos_vencer, 800);
                animateValue('vencidos', 0, stats.vencidos, 800);
                
                // Actualizar badge de vencimientos
                const totalVencimientos = stats.proximos_vencer + stats.vencidos;
                const badge = document.getElementById('vencimientos-badge');
                if (badge) badge.textContent = totalVencimientos;
                
                // Actualizar mini-contadores en la tarjeta de vencimientos
                const proximosMini = document.getElementById('proximos-vencer-mini');
                const vencidosMini = document.getElementById('vencidos-mini');
                if (proximosMini) proximosMini.textContent = stats.proximos_vencer;
                if (vencidosMini) vencidosMini.textContent = stats.vencidos;
                
                console.log('✅ Estadísticas FIFO cargadas:', stats);
            } else {
                mostrarErrorEstadisticas();
            }
        })
        .catch(error => {
            console.error('❌ Error al cargar estadísticas:', error);
            mostrarErrorEstadisticas();
        });
}

// Función auxiliar para animar números
function animateValue(id, start, end, duration) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const range = end - start;
    const increment = range / (duration / 16); // ~60fps
    let current = start;
    
    const timer = setInterval(function() {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 16);
}

// Mostrar error en estadísticas
function mostrarErrorEstadisticas() {
    const elementos = {
        'total-lotes': '0',
        'articulos-fifo': '0',
        'proximos-vencer': '0',
        'vencidos': '0',
        'vencimientos-badge': '0'
    };
    
    Object.keys(elementos).forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = elementos[id];
    });
}

// Cargar artículos disponibles para autocompletado
function cargarArticulosDisponibles() {
    fetch('/lotes/api/inventario/activos')
        .then(response => response.json())
        .then(data => {
            articulosDisponibles = data.articulos || [];
            console.log('✅ Artículos disponibles cargados:', articulosDisponibles.length);
            // Cargar selector de filtros
            cargarArticulosFiltro();
        })
        .catch(error => {
            console.log('⚠️ Error al cargar artículos disponibles:', error);
        });
}

// Actualizar sugerencias de artículos dinámicamente
function actualizarSugerenciasArticulos(termino) {
    const datalist = document.getElementById('articulos-list');
    if (!datalist || !termino || termino.length < 2) {
        if (datalist) datalist.innerHTML = '';
        return;
    }
    
    const terminoLower = termino.toLowerCase();
    const sugerencias = articulosDisponibles
        .filter(art => 
            art.codigo.toLowerCase().includes(terminoLower) ||
            (art.nombre && art.nombre.toLowerCase().includes(terminoLower))
        )
        .slice(0, 10); // Limitar a 10 sugerencias
    
    datalist.innerHTML = sugerencias
        .map(art => `<option value="${art.codigo}">${art.nombre}</option>`)
        .join('');
}

// Actualizar sugerencias de lotes dinámicamente
function actualizarSugerenciasLotes(termino) {
    const datalist = document.getElementById('lotes-list');
    if (!datalist || !termino || termino.length < 1) {
        if (datalist) datalist.innerHTML = '';
        return;
    }
    
    // Hacer fetch de lotes disponibles
    fetch(`/lotes/api/lotes/activos?page=1&per_page=50`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.lotes) {
                const terminoLower = termino.toLowerCase();
                const sugerencias = data.lotes
                    .filter(lote => 
                        lote.id.toString().includes(terminoLower) ||
                        (lote.codigo_lote && lote.codigo_lote.toLowerCase().includes(terminoLower))
                    )
                    .slice(0, 10);
                
                datalist.innerHTML = sugerencias
                    .map(lote => `<option value="${lote.codigo_lote || lote.id}">Lote ${lote.codigo_lote || lote.id} - ${lote.inventario_nombre}</option>`)
                    .join('');
            }
        })
        .catch(error => console.log('Error al cargar sugerencias de lotes:', error));
}

// Buscar artículo
function buscarArticulo() {
    const inputElem = document.getElementById('buscar-articulo');
    const termino = inputElem ? inputElem.value.trim() : '';
    
    if (!termino) {
        mostrarMensaje('Por favor ingrese un término de búsqueda', 'warning');
        return;
    }

    // Mostrar loading
    const resultadosDiv = document.getElementById('resultados-busqueda');
    const tbodyResultados = document.getElementById('tbody-resultados');
    
    if (resultadosDiv) resultadosDiv.style.display = 'block';
    if (tbodyResultados) {
        tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</td></tr>';
    }

    // Buscar en artículos locales primero
    const resultadosLocales = articulosDisponibles.filter(art => 
        art.codigo.toLowerCase().includes(termino.toLowerCase()) ||
        (art.nombre && art.nombre.toLowerCase().includes(termino.toLowerCase()))
    );
    
    if (resultadosLocales.length === 1) {
        // Si hay exactamente un resultado, ir directamente a su página
        window.location.href = `/lotes/inventario/${resultadosLocales[0].id}`;
    } else if (resultadosLocales.length > 1) {
        // Mostrar múltiples resultados
        mostrarResultadosBusqueda(resultadosLocales);
    } else {
        // Búsqueda en servidor
        fetch(`/api/inventario/buscar?q=${encodeURIComponent(termino)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.articulos && data.articulos.length > 0) {
                    mostrarResultadosBusqueda(data.articulos);
                } else {
                    if (tbodyResultados) {
                        tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No se encontraron artículos</td></tr>';
                    }
                }
            })
            .catch(error => {
                console.error('Error en búsqueda:', error);
                if (tbodyResultados) {
                    tbodyResultados.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al realizar la búsqueda</td></tr>';
                }
            });
    }
}

// Mostrar resultados de búsqueda
function mostrarResultadosBusqueda(articulos) {
    let html = '';
    
    articulos.forEach(function(articulo) {
        const stockDisponible = articulo.stock_disponible || 0;
        const lotesActivos = articulo.lotes_activos || 0;
        const proximoVencimiento = articulo.proximo_vencimiento || 'N/A';
        
        html += `
            <tr>
                <td><strong>${articulo.codigo}</strong></td>
                <td>${articulo.nombre || ''}</td>
                <td>
                    <span class="badge badge-${stockDisponible > 0 ? 'success' : 'danger'}">
                        ${stockDisponible} ${articulo.unidad_medida || 'UN'}
                    </span>
                </td>
                <td>${lotesActivos}</td>
                <td>${proximoVencimiento}</td>
                <td>
                    <a href="/lotes/inventario/${articulo.id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Ver Lotes
                    </a>
                </td>
            </tr>
        `;
    });
    
    const tbody = document.getElementById('tbody-resultados');
    if (tbody) tbody.innerHTML = html;
}

// Ver lotes activos
function verLotesActivos(pagina = 1) {
    paginaActualLotes = pagina;
    const filtrosDiv = document.getElementById('filtros-lotes-activos');
    const tablaLotesDiv = document.getElementById('tabla-lotes-activos');
    const tbodyLotes = document.getElementById('tbody-lotes');
    
    // Mostrar filtros y tabla
    if (filtrosDiv) filtrosDiv.style.display = 'block';
    if (tablaLotesDiv) tablaLotesDiv.style.display = 'block';
    
    if (tbodyLotes) {
        tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando lotes...</td></tr>';
    }
    
    // Construir URL con parámetros de paginación y filtros
    const params = new URLSearchParams({
        page: pagina,
        per_page: porPaginaLotes
    });
    
    // Agregar filtros si están activos
    const filtroArticulo = document.getElementById('filtro-articulo')?.value;
    const filtroCodigoLote = document.getElementById('filtro-codigo-lote')?.value;
    const filtroFechaEntradaDesde = document.getElementById('filtro-fecha-entrada-desde')?.value;
    const filtroFechaEntradaHasta = document.getElementById('filtro-fecha-entrada-hasta')?.value;
    
    if (filtroArticulo) params.append('inventario_id', filtroArticulo);
    if (filtroCodigoLote) params.append('codigo_lote', filtroCodigoLote);
    if (filtroFechaEntradaDesde) params.append('fecha_entrada_desde', filtroFechaEntradaDesde);
    if (filtroFechaEntradaHasta) params.append('fecha_entrada_hasta', filtroFechaEntradaHasta);
    
    fetch(`/lotes/api/lotes/activos?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                paginacionInfo = data.pagination || {};
                if (data.lotes && data.lotes.length > 0) {
                    mostrarLotesActivos(data.lotes);
                    actualizarPaginacion();
                    actualizarInfoRegistros();
                } else {
                    if (tbodyLotes) {
                        tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay lotes activos</td></tr>';
                    }
                    limpiarPaginacion();
                }
            } else {
                if (tbodyLotes) {
                    tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error: ' + (data.error || 'Error desconocido') + '</td></tr>';
                }
            }
        })
        .catch(error => {
            console.error('Error al cargar lotes:', error);
            if (tbodyLotes) {
                tbodyLotes.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar lotes</td></tr>';
            }
        });
}

// Mostrar lotes activos
function mostrarLotesActivos(lotes) {
    let html = '';
    
    lotes.forEach(function(lote) {
        const fechaVencimiento = lote.fecha_vencimiento ? 
            new Date(lote.fecha_vencimiento).toLocaleDateString() : 'N/A';
        const fechaEntrada = new Date(lote.fecha_entrada).toLocaleDateString();
        
        // Determinar estado del lote
        let estadoBadge = 'badge-success';
        let estadoTexto = 'Activo';
        
        if (lote.fecha_vencimiento) {
            const hoy = new Date();
            const vencimiento = new Date(lote.fecha_vencimiento);
            const diasRestantes = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
            
            if (diasRestantes < 0) {
                estadoBadge = 'badge-danger';
                estadoTexto = 'Vencido';
            } else if (diasRestantes <= 30) {
                estadoBadge = 'badge-warning';
                estadoTexto = 'Por vencer';
            }
        }
        
        html += `
            <tr>
                <td><strong>${lote.id}</strong></td>
                <td>${lote.codigo_lote || 'Auto-' + lote.id}</td>
                <td>
                    <div><strong>${lote.inventario_codigo || 'N/A'}</strong></div>
                    <small class="text-muted">${lote.inventario_nombre || 'N/A'}</small>
                </td>
                <td>
                    <strong>${lote.cantidad_disponible || 0}</strong>
                    <br>
                    <small class="text-muted">Inicial: ${lote.cantidad_inicial || 0}</small>
                </td>
                <td>${fechaEntrada}</td>
                <td>${fechaVencimiento}</td>
                <td>
                    <span class="badge ${estadoBadge}">${estadoTexto}</span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary action-btn" onclick="window.location.href='/lotes/inventario/${lote.inventario_id}'" title="Ver Inventario">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info action-btn info" onclick="verTrazabilidad(${lote.id})" title="Ver Trazabilidad">
                            <i class="bi bi-diagram-3"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    const tbody = document.getElementById('tbody-lotes');
    if (tbody) tbody.innerHTML = html;
}

// Buscar lote específico
function buscarLote() {
    const inputElem = document.getElementById('buscar-lote');
    const loteId = inputElem ? inputElem.value.trim() : '';
    
    if (!loteId) {
        mostrarMensaje('Por favor ingrese un ID de lote', 'warning');
        return;
    }
    
    verTrazabilidad(loteId);
}

// Ver trazabilidad de un lote
function verTrazabilidad(loteId) {
    window.location.href = `/lotes/trazabilidad?lote=${loteId}`;
}

// Función auxiliar para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    const tipoClase = tipo === 'error' ? 'danger' : tipo;
    const html = `
        <div class="alert alert-${tipoClase} alert-dismissible fade show">
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insertar al inicio del contenido
    const container = document.querySelector('.container-fluid');
    if (container) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        container.insertBefore(tempDiv.firstElementChild, container.firstChild);
        
        // Auto-ocultar después de 5 segundos
        setTimeout(function() {
            const alerts = container.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);
    }
}

// ===== FUNCIONES DE PAGINACIÓN Y FILTROS =====

// Actualizar paginación
function actualizarPaginacion() {
    const paginationContainer = document.getElementById('paginacion-lotes');
    
    if (!paginacionInfo || !paginacionInfo.pages) return;
    
    const html = generarHTMLPaginacion();
    if (paginationContainer) paginationContainer.innerHTML = html;
}

// Generar HTML de paginación
function generarHTMLPaginacion() {
    const { current_page, pages, has_prev, has_next, per_page, total } = paginacionInfo;
    
    if (pages <= 1) return '';
    
    const desde = ((current_page - 1) * per_page) + 1;
    const hasta = Math.min(current_page * per_page, total);
    
    let html = '<div class="d-flex justify-content-between align-items-center flex-wrap gap-3">';
    
    // Info de registros
    html += `
        <div class="small text-muted">
            Mostrando <strong>${desde}</strong> a <strong>${hasta}</strong> de <strong>${total}</strong> lotes
        </div>
    `;
    
    // Controles de paginación
    html += '<div class="d-flex align-items-center gap-2">';
    
    // Selector de items por página
    html += `
        <div class="d-flex align-items-center gap-2">
            <label class="small mb-0">Mostrar:</label>
            <select class="form-select form-select-sm" style="width: auto;" onchange="cambiarPorPagina(this.value)">
                <option value="10" ${per_page === 10 ? 'selected' : ''}>10</option>
                <option value="25" ${per_page === 25 ? 'selected' : ''}>25</option>
                <option value="50" ${per_page === 50 ? 'selected' : ''}>50</option>
                <option value="100" ${per_page === 100 ? 'selected' : ''}>100</option>
            </select>
        </div>
    `;
    
    // Botones de paginación
    html += '<ul class="pagination pagination-sm mb-0">';
    
    // Botón Anterior
    html += `
        <li class="page-item ${!has_prev ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cambiarPaginaLotes(${current_page - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Números de página
    const maxVisible = 5;
    let startPage = Math.max(1, current_page - Math.floor(maxVisible / 2));
    let endPage = Math.min(pages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    // Primera página
    if (startPage > 1) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="cambiarPaginaLotes(1); return false;">1</a>
            </li>
        `;
        if (startPage > 2) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Páginas visibles
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === current_page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="cambiarPaginaLotes(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Última página
    if (endPage < pages) {
        if (endPage < pages - 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="cambiarPaginaLotes(${pages}); return false;">${pages}</a>
            </li>
        `;
    }
    
    // Botón Siguiente
    html += `
        <li class="page-item ${!has_next ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cambiarPaginaLotes(${current_page + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;
    
    html += '</ul></div></div>';
    
    return html;
}

// Cambiar página de lotes
function cambiarPaginaLotes(pagina) {
    if (pagina < 1 || (paginacionInfo.pages && pagina > paginacionInfo.pages)) return;
    verLotesActivos(pagina);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Cambiar cantidad por página
function cambiarPorPagina(valor) {
    porPaginaLotes = parseInt(valor || 10);
    verLotesActivos(1); // Volver a la primera página
}

// Actualizar información de registros
function actualizarInfoRegistros() {
    const infoElem = document.getElementById('info-registros');
    if (!infoElem || !paginacionInfo) return;
    
    const { total } = paginacionInfo;
    infoElem.textContent = `${total} ${total === 1 ? 'lote' : 'lotes'}`;
}

// Limpiar paginación
function limpiarPaginacion() {
    const paginationContainer = document.getElementById('paginacion-lotes');
    const infoElem = document.getElementById('info-registros');
    
    if (paginationContainer) paginationContainer.innerHTML = '';
    if (infoElem) infoElem.textContent = '0 lotes';
}

// Aplicar filtros
function aplicarFiltrosLotes() {
    verLotesActivos(1); // Volver a la primera página al filtrar
}

// Limpiar filtros
function limpiarFiltrosLotes() {
    document.getElementById('filtro-articulo').value = '';
    document.getElementById('filtro-codigo-lote').value = '';
    document.getElementById('filtro-fecha-entrada-desde').value = '';
    document.getElementById('filtro-fecha-entrada-hasta').value = '';
    verLotesActivos(1);
}

// Cargar artículos en el selector de filtros
function cargarArticulosFiltro() {
    const selectElem = document.getElementById('filtro-articulo');
    if (!selectElem || !articulosDisponibles || articulosDisponibles.length === 0) return;
    
    let html = '<option value="">Todos los artículos</option>';
    articulosDisponibles.forEach(articulo => {
        html += `<option value="${articulo.id}">${articulo.codigo} - ${articulo.nombre}</option>`;
    });
    selectElem.innerHTML = html;
}

// Ocultar lotes activos
function ocultarLotesActivos() {
    const filtrosDiv = document.getElementById('filtros-lotes-activos');
    const tablaLotesDiv = document.getElementById('tabla-lotes-activos');
    
    if (filtrosDiv) filtrosDiv.style.display = 'none';
    if (tablaLotesDiv) tablaLotesDiv.style.display = 'none';
}
</script>
{% endblock %}