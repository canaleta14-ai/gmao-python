{% extends "base.html" %}

{% block title %}Administrar Solicitudes - GMAO{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-clipboard-check me-2 text-primary"></i>
                        Gestión de Solicitudes de Servicio
                    </h1>
                    <p class="text-muted mb-0">Administre las solicitudes de mantenimiento enviadas por los usuarios</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="exportarSolicitudes()">
                        <i class="bi bi-download me-1"></i>Exportar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card h-100 border-start border-primary border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-clock-history fs-2 text-primary"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 text-primary">{{ estadisticas.total_pendientes }}</h4>
                                    <small class="text-muted">Pendientes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 border-start border-warning border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-eye fs-2 text-warning"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 text-warning">{{ estadisticas.total_revision }}</h4>
                                    <small class="text-muted">En Revisión</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 border-start border-info border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-gear fs-2 text-info"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 text-info">{{ estadisticas.total_progreso }}</h4>
                                    <small class="text-muted">En Progreso</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 border-start border-success border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-check-circle fs-2 text-success"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 text-success">{{ estadisticas.total_completadas }}</h4>
                                    <small class="text-muted">Completadas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros modernos colapsables -->
            <div class="filtros-container">
                <div class="filtros-header" data-bs-toggle="collapse" data-bs-target="#filtros-collapse">
                    <h6><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h6>
                </div>
                <div id="filtros-collapse" class="collapse">
                    <div class="filtros-body">
                        <form id="filtrosForm" class="row g-3">
                            <div class="col-lg-3 col-md-6">
                                <label for="estado" class="form-label fw-bold">Estado</label>
                                <select class="form-select" id="estado" name="estado">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente" {{ 'selected' if request.args.get('estado') == 'pendiente' }}>Pendiente</option>
                                    <option value="en_revision" {{ 'selected' if request.args.get('estado') == 'en_revision' }}>En Revisión</option>
                                    <option value="aprobada" {{ 'selected' if request.args.get('estado') == 'aprobada' }}>Aprobada</option>
                                    <option value="en_progreso" {{ 'selected' if request.args.get('estado') == 'en_progreso' }}>En Progreso</option>
                                    <option value="completada" {{ 'selected' if request.args.get('estado') == 'completada' }}>Completada</option>
                                    <option value="rechazada" {{ 'selected' if request.args.get('estado') == 'rechazada' }}>Rechazada</option>
                                    <option value="cancelada" {{ 'selected' if request.args.get('estado') == 'cancelada' }}>Cancelada</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label for="prioridad" class="form-label fw-bold">Prioridad</label>
                                <select class="form-select" id="prioridad" name="prioridad">
                                    <option value="">Todas las prioridades</option>
                                    <option value="baja" {{ 'selected' if request.args.get('prioridad') == 'baja' }}>Baja</option>
                                    <option value="normal" {{ 'selected' if request.args.get('prioridad') == 'normal' }}>Normal</option>
                                    <option value="alta" {{ 'selected' if request.args.get('prioridad') == 'alta' }}>Alta</option>
                                    <option value="urgente" {{ 'selected' if request.args.get('prioridad') == 'urgente' }}>Urgente</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label for="tipo_servicio" class="form-label fw-bold">Tipo de Servicio</label>
                                <select class="form-select" id="tipo_servicio" name="tipo_servicio">
                                    <option value="">Todos los tipos</option>
                                    <option value="mantenimiento" {{ 'selected' if request.args.get('tipo_servicio') == 'mantenimiento' }}>Mantenimiento</option>
                                    <option value="reparacion" {{ 'selected' if request.args.get('tipo_servicio') == 'reparacion' }}>Reparación</option>
                                    <option value="instalacion" {{ 'selected' if request.args.get('tipo_servicio') == 'instalacion' }}>Instalación</option>
                                    <option value="otro" {{ 'selected' if request.args.get('tipo_servicio') == 'otro' }}>Otro</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label for="busqueda" class="form-label fw-bold">Buscar</label>
                                <input type="text" class="form-control" id="busqueda" name="busqueda"
                                       value="{{ request.args.get('busqueda', '') }}"
                                       placeholder="Número, nombre, email...">
                            </div>
                            <div class="col-12">
                                <hr class="mb-3">
                                <div class="d-flex gap-2 flex-wrap align-items-center">
                                    <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                        <i class="bi bi-x-circle me-1"></i>Limpiar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tabla de Solicitudes -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Solicitudes ({{ solicitudes.total }})
                    </h6>
                    <small class="text-muted">Mostrando {{ solicitudes.items|length }} de {{ solicitudes.total }} solicitudes</small>
                </div>
                <div class="card-body p-0">
                    {% if solicitudes %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">#</th>
                                        <th class="border-0">Solicitante</th>
                                        <th class="border-0">Tipo</th>
                                        <th class="border-0">Prioridad</th>
                                        <th class="border-0">Estado</th>
                                        <th class="border-0">Fecha</th>
                                        <th class="border-0">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for solicitud in solicitudes %}
                                    <tr>
                                        <td>
                                            <strong class="text-primary">{{ solicitud.numero_solicitud }}</strong>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ solicitud.nombre_solicitante }}</strong>
                                                <br>
                                                <small class="text-muted">{{ solicitud.email_solicitante }}</small>
                                                {% if solicitud.telefono_solicitante %}
                                                <br>
                                                <small class="text-muted"><i class="bi bi-telephone me-1"></i>{{ solicitud.telefono_solicitante }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ solicitud.tipo_servicio_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'secondary' if solicitud.prioridad == 'baja' else 'primary' if solicitud.prioridad == 'normal' else 'warning' if solicitud.prioridad == 'alta' else 'danger' }}">
                                                {{ solicitud.prioridad_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'primary' if solicitud.estado == 'pendiente' else 'warning' if solicitud.estado == 'en_revision' else 'success' if solicitud.estado == 'aprobada' else 'info' if solicitud.estado == 'en_progreso' else 'success' if solicitud.estado == 'completada' else 'danger' if solicitud.estado == 'rechazada' else 'secondary' }}">
                                                {{ solicitud.estado_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>{{ solicitud.fecha_creacion.strftime('%d/%m/%Y') }}</small>
                                            <br>
                                            <small class="text-muted">{{ solicitud.fecha_creacion.strftime('%H:%M') }}</small>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1 justify-content-center">
                                                <button class="btn btn-sm btn-outline-primary action-btn view"
                                                        onclick="window.location.href='{{ url_for('solicitudes_admin.ver_solicitud', id=solicitud.id) }}'"
                                                        title="Ver detalles">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary action-btn edit"
                                                        onclick="window.location.href='{{ url_for('solicitudes_admin.editar_solicitud', id=solicitud.id) }}'"
                                                        title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info action-btn info"
                                                        onclick="cambiarEstado({{ solicitud.id }}, '{{ solicitud.estado }}')"
                                                        title="Cambiar estado">
                                                    <i class="bi bi-arrow-right-circle"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación dinámica -->
                        <div class="card-footer">
                            <div class="pagination-container">
                                <!-- La paginación se actualizará dinámicamente con JavaScript -->
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">No se encontraron solicitudes</h5>
                            <p class="text-muted mb-0">No hay solicitudes que coincidan con los criterios de búsqueda.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="cambiarEstadoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado de Solicitud</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="cambiarEstadoForm">
                <div class="modal-body">
                    <input type="hidden" id="solicitudId" name="solicitud_id">
                    <div class="mb-3">
                        <label for="nuevoEstado" class="form-label">Nuevo Estado</label>
                        <select class="form-select" id="nuevoEstado" name="estado" required>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_revision">En Revisión</option>
                            <option value="aprobada">Aprobada</option>
                            <option value="en_progreso">En Progreso</option>
                            <option value="completada">Completada</option>
                            <option value="rechazada">Rechazada</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comentarioEstado" class="form-label">Comentario (opcional)</label>
                        <textarea class="form-control" id="comentarioEstado" name="comentario" rows="3"
                                  placeholder="Agregue un comentario sobre el cambio de estado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Cambiar Estado</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function cambiarEstado(solicitudId, estadoActual) {
    document.getElementById('solicitudId').value = solicitudId;
    document.getElementById('nuevoEstado').value = estadoActual;
    new bootstrap.Modal(document.getElementById('cambiarEstadoModal')).show();
}

document.getElementById('cambiarEstadoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const solicitudId = formData.get('solicitud_id');
    const nuevoEstado = formData.get('estado');
    const comentario = formData.get('comentario');

    fetch(`/admin/solicitudes/${solicitudId}/estado`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            estado: nuevoEstado,
            comentario: comentario
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('cambiarEstadoModal')).hide();
            location.reload();
        } else {
            mostrarMensaje('Error al cambiar el estado: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error de conexión', 'danger');
    });
});

function exportarSolicitudes() {
    const url = new URL(window.location);
    url.pathname = '/admin/solicitudes/exportar';
    window.open(url, '_blank');
}

// ========== FUNCIONES PARA FILTROS DINÁMICOS ==========

let currentPage = 1;
let currentFilters = {};

// Función para aplicar filtros
function aplicarFiltros(page = 1) {
    const filtros = {
        estado: document.getElementById('estado').value,
        prioridad: document.getElementById('prioridad').value,
        tipo_servicio: document.getElementById('tipo_servicio').value,
        busqueda: document.getElementById('busqueda').value.trim(),
        page: page
    };

    currentFilters = filtros;
    currentPage = page;

    // Mostrar loading
    mostrarCargando();

    const url = '/admin/solicitudes/api/filtrar?' + new URLSearchParams(filtros);

    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    // Sesión expirada
                    throw new Error('Sesión expirada. Por favor, recarga la página e inicia sesión nuevamente.');
                } else if (response.status === 403) {
                    // Sin permisos
                    throw new Error('No tienes permisos para realizar esta acción.');
                } else {
                    throw new Error('Error HTTP: ' + response.status);
                }
            }
            return response.json();
        })
        .then(data => {
            actualizarTabla(data);
            actualizarPaginacion(data);
            ocultarCargando();
        })
        .catch(error => {
            console.error('Error al filtrar:', error);
            ocultarCargando();
            
            // Mostrar mensaje de error
            if (typeof mostrarMensaje === 'function') {
                mostrarMensaje('Error al aplicar filtros: ' + error.message, 'danger');
            } else if (typeof mostrarAlerta === 'function') {
                mostrarAlerta('Error al aplicar filtros: ' + error.message, 'danger');
            } else {
                console.error('Error al aplicar filtros:', error.message);
            }
        });
}

// Función para limpiar filtros
function limpiarFiltros() {
    document.getElementById('estado').value = '';
    document.getElementById('prioridad').value = '';
    document.getElementById('tipo_servicio').value = '';
    document.getElementById('busqueda').value = '';
    currentFilters = {};
    currentPage = 1;
    aplicarFiltros(1);
}

// Función para actualizar la tabla con los resultados
function actualizarTabla(data) {
    const tbody = document.querySelector('.table tbody');
    const header = document.querySelector('.card-header small');

    if (!tbody) {
        console.error('No se encontró el tbody de la tabla');
        return;
    }

    if (data.solicitudes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="bi bi-inbox fs-1 text-muted mb-2"></i>
                    <p class="text-muted mb-0">No se encontraron solicitudes con los filtros aplicados</p>
                </td>
            </tr>
        `;
        if (header) {
            header.textContent = `Mostrando 0 de ${data.total} solicitudes`;
        }
        return;
    }

    let html = '';
    data.solicitudes.forEach(solicitud => {
        const estadoClass = getEstadoClass(solicitud.estado);
        const prioridadClass = getPrioridadClass(solicitud.prioridad);

        html += `
            <tr>
                <td>
                    <strong class="text-primary">${solicitud.numero_solicitud}</strong>
                </td>
                <td>
                    <div>
                        <strong>${solicitud.nombre_solicitante}</strong>
                        <br>
                        <small class="text-muted">${solicitud.email_solicitante}</small>
                        ${solicitud.telefono_solicitante ? `<br><small class="text-muted"><i class="bi bi-telephone me-1"></i>${solicitud.telefono_solicitante}</small>` : ''}
                    </div>
                </td>
                <td>
                    <span class="badge bg-secondary">${solicitud.tipo_servicio || 'N/A'}</span>
                </td>
                <td>
                    <span class="badge ${prioridadClass}">${solicitud.prioridad || 'N/A'}</span>
                </td>
                <td>
                    <span class="badge ${estadoClass}">${getEstadoTexto(solicitud.estado)}</span>
                </td>
                <td>
                    <small class="text-muted">${solicitud.fecha_creacion}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="/admin/solicitudes/${solicitud.id}" class="btn btn-sm btn-outline-primary" title="Ver">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="/admin/solicitudes/${solicitud.id}/editar" class="btn btn-sm btn-outline-warning" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="cambiarEstado(${solicitud.id})" title="Cambiar Estado">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    if (header) {
        header.textContent = `Mostrando ${data.solicitudes.length} de ${data.total} solicitudes`;
    }
}

// Función para actualizar la paginación
function actualizarPaginacion(data) {
    const paginationContainer = document.querySelector('.pagination-container');
    if (!paginationContainer) return;

    if (data.pages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    let html = '<nav><ul class="pagination justify-content-center">';

    // Botón anterior
    if (data.has_prev) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="aplicarFiltros(${data.prev_page})">Anterior</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Anterior</span></li>';
    }

    // Páginas
    for (let i = Math.max(1, data.current_page - 2); i <= Math.min(data.pages, data.current_page + 2); i++) {
        if (i === data.current_page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="aplicarFiltros(${i})">${i}</a></li>`;
        }
    }

    // Botón siguiente
    if (data.has_next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="aplicarFiltros(${data.next_page})">Siguiente</a></li>`;
    } else {
        html += '<li class="page-item disabled"><span class="page-link">Siguiente</span></li>';
    }

    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

// Funciones auxiliares para estilos
function getEstadoClass(estado) {
    const classes = {
        'pendiente': 'bg-warning text-dark',
        'en_revision': 'bg-info',
        'aprobada': 'bg-success',
        'en_progreso': 'bg-primary',
        'completada': 'bg-success',
        'rechazada': 'bg-danger',
        'cancelada': 'bg-secondary'
    };
    return classes[estado] || 'bg-secondary';
}

function getEstadoTexto(estado) {
    const textos = {
        'pendiente': 'Pendiente',
        'en_revision': 'En Revisión',
        'aprobada': 'Aprobada',
        'en_progreso': 'En Progreso',
        'completada': 'Completada',
        'rechazada': 'Rechazada',
        'cancelada': 'Cancelada'
    };
    return textos[estado] || estado;
}

function getPrioridadClass(prioridad) {
    const classes = {
        'baja': 'bg-success',
        'normal': 'bg-warning text-dark',
        'alta': 'bg-danger',
        'urgente': 'bg-danger'
    };
    return classes[prioridad] || 'bg-secondary';
}

// Función para mostrar loading
function mostrarCargando() {
    const tabla = document.querySelector('.table-responsive');
    if (tabla) {
        tabla.style.opacity = '0.5';
        tabla.style.pointerEvents = 'none';
    }
}

// Función para ocultar loading
function ocultarCargando() {
    const tabla = document.querySelector('.table-responsive');
    if (tabla) {
        tabla.style.opacity = '1';
        tabla.style.pointerEvents = 'auto';
    }
}

// Inicializar filtros dinámicos cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Prevenir submit del formulario de filtros
    const filtrosForm = document.getElementById('filtrosForm');
    if (filtrosForm) {
        filtrosForm.addEventListener('submit', function(e) {
            e.preventDefault();
            aplicarFiltros(1);
        });
    }

    // Agregar event listeners para los selects de filtro
    const estadoSelect = document.getElementById('estado');
    const prioridadSelect = document.getElementById('prioridad');
    const tipoServicioSelect = document.getElementById('tipo_servicio');

    if (estadoSelect) {
        estadoSelect.addEventListener('change', () => aplicarFiltros(1));
    }
    if (prioridadSelect) {
        prioridadSelect.addEventListener('change', () => aplicarFiltros(1));
    }
    if (tipoServicioSelect) {
        tipoServicioSelect.addEventListener('change', () => aplicarFiltros(1));
    }

    // Agregar event listeners para búsqueda en tiempo real
    const busquedaInput = document.getElementById('busqueda');
    if (busquedaInput) {
        let timeoutId;
        busquedaInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                aplicarFiltros(1);
            }, 500);
        });
    }

    // Aplicar filtros iniciales (vacíos) - esto carga todos los datos
    setTimeout(() => aplicarFiltros(1), 100);
});
</script>

<!-- Los scripts principales (main.js, etc.) ya están cargados en base.html -->
{% endblock %}