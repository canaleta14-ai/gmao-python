{% extends "base.html" %} {% block title %}Calendario de √ìrdenes{% endblock %}
{% block extra_css %}
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
  rel="stylesheet"
/>
<style>
  /* Estilos espec√≠ficos del calendario ahora est√°n en style.css */
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Tarjetas de estad√≠sticas modernizadas -->
  <div class="row mb-4" id="estadisticas-cards">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card primary">
        <div class="card-body">
          <i class="bi bi-calendar-check stats-icon text-primary"></i>
          <div class="stats-number text-primary" id="total-ordenes">0</div>
          <div class="stats-label">√ìrdenes Este Mes</div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card warning">
        <div class="card-body">
          <i class="bi bi-calendar-event stats-icon text-warning"></i>
          <div class="stats-number text-warning" id="planes-programados">0</div>
          <div class="stats-label">Planes Programados</div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card danger">
        <div class="card-body">
          <i class="bi bi-clock stats-icon text-danger"></i>
          <div class="stats-number text-danger" id="ordenes-pendientes">0</div>
          <div class="stats-label">Pendientes</div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card success">
        <div class="card-body">
          <i class="bi bi-check-circle stats-icon text-success"></i>
          <div class="stats-number text-success" id="ordenes-completadas">
            0
          </div>
          <div class="stats-label">Completadas</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="row mb-3">
    <div class="col-md-6">
      <h2><i class="bi bi-calendar3"></i> Calendario de √ìrdenes de Trabajo</h2>
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-generar btn-sm me-2" onclick="generarOrdenesHoy()">
        <i class="bi bi-gear"></i> Generar √ìrdenes Hoy
      </button>
      <button
        class="btn btn-outline-secondary btn-sm"
        onclick="actualizarCalendario()"
      >
        <i class="bi bi-arrow-clockwise"></i> Actualizar
      </button>
    </div>
  </div>

  <!-- Leyenda -->
  <div class="leyenda">
    <div class="leyenda-item">
      <div
        class="leyenda-color"
        style="background-color: var(--warning-color)"
      ></div>
      <span>Pendiente</span>
    </div>
    <div class="leyenda-item">
      <div
        class="leyenda-color"
        style="background-color: var(--info-color)"
      ></div>
      <span>En Proceso</span>
    </div>
    <div class="leyenda-item">
      <div
        class="leyenda-color"
        style="background-color: var(--success-color)"
      ></div>
      <span>Completada</span>
    </div>
    <div class="leyenda-item">
      <div
        class="leyenda-color"
        style="background-color: var(--danger-color)"
      ></div>
      <span>Cancelada</span>
    </div>
    <div class="leyenda-item">
      <div
        class="leyenda-color"
        style="background-color: var(--primary-color)"
      ></div>
      <span>Plan Futuro</span>
    </div>
  </div>

  <!-- Calendario -->
  <div class="card">
    <div class="card-body p-4">
      <div id="calendario"></div>
    </div>
  </div>
</div>

<!-- Modal para detalles del evento -->
<div class="modal fade" id="modalEvento" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEventoTitle"></h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="modalEventoBody">
        <!-- Contenido din√°mico -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js"></script>

<script>
  // Versi√≥n del script para verificar cach√©
  console.log('üîß Calendario Script v3.0 - Punto medio del rango');
  
  document.addEventListener("DOMContentLoaded", function () {
    console.log('üìÖ Inicializando calendario FullCalendar...');
    const calendarEl = document.getElementById("calendario");
    
    // Obtener fecha actual
    const hoy = new Date();
    console.log(`üìÜ Fecha actual: ${hoy.toLocaleDateString('es-ES')} (Mes: ${hoy.getMonth() + 1})`);

    // Variable local para el calendario
    let calendar;

    // Inicializar calendario (variable global para acceso desde consola)
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      initialDate: hoy, // Forzar fecha inicial a hoy
      locale: "es",
      timeZone: 'local', // Usar zona horaria local
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,listWeek",
      },
      buttonText: {
        today: "hoy",
        month: "mes",
        week: "semana",
        list: "lista",
        dayGridMonth: "mes",
        timeGridWeek: "semana",
        listWeek: "lista",
      },
      height: "auto",
      events: function (info, successCallback, failureCallback) {
        cargarEventos(info.start, info.end, successCallback, failureCallback);
      },
      eventClick: function (info) {
        mostrarDetalleEvento(info.event);
      },
      datesSet: function (info) {
        // Se ejecuta cuando cambia el mes/vista
        console.log(`üìÖ datesSet llamado: ${info.start.toLocaleDateString('es-ES')} a ${info.end.toLocaleDateString('es-ES')}`);
        cargarEstadisticas(info.start);
      },
      eventDidMount: function(info) {
        console.log('üé® Evento renderizado:', info.event.title, info.event.startStr);
      },
      loading: function(isLoading) {
        if (isLoading) {
          console.log('‚è≥ Cargando eventos del calendario...');
        } else {
          console.log('‚úÖ Eventos cargados');
        }
      }
    });

    // Asignar a window DESPU√âS de crear el calendario
    window.calendar = calendar;

    window.calendar.render();
    console.log('‚úÖ Calendario renderizado');

    // Funciones auxiliares
    function cargarEventos(start, end, successCallback, failureCallback) {
      // FullCalendar pasa el rango completo que incluye d√≠as del mes anterior/siguiente
      // Para obtener el mes correcto, calculamos el punto medio del rango
      const rangoMs = end.getTime() - start.getTime();
      const puntoMedio = new Date(start.getTime() + rangoMs / 2);
      
      const year = puntoMedio.getFullYear();
      const month = puntoMedio.getMonth() + 1; // 0-11 a 1-12
      const url = `/calendario/api/ordenes?year=${year}&month=${month}`;
      
      console.log(`üì° Cargando eventos: ${url}`);
      console.log(`   Punto medio del rango: ${puntoMedio.toLocaleDateString('es-ES')} (${month}/${year})`);
      console.log(`   Rango FullCalendar: ${start.toLocaleDateString('es-ES')} - ${end.toLocaleDateString('es-ES')}`);
      
      fetch(url)
        .then((response) => {
          // Verificar si la respuesta es JSON o HTML (redirect a login)
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.error('‚ö†Ô∏è Respuesta no es JSON - Posible sesi√≥n expirada');
            console.log('üîÑ Recargando p√°gina para renovar sesi√≥n...');
            setTimeout(() => location.reload(), 2000);
            throw new Error('Sesi√≥n expirada - recargando p√°gina');
          }
          return response.json();
        })
        .then((data) => {
          if (data.success) {
            console.log(`‚úÖ ${data.eventos.length} eventos recibidos de la API`);
            if (data.eventos.length > 0) {
              console.log('   Eventos:', data.eventos.map(e => `${e.title} (${e.start})`).join(', '));
            }
            successCallback(data.eventos);
          } else {
            console.error("‚ùå Error cargando eventos:", data.error);
            failureCallback(data.error);
          }
        })
        .catch((error) => {
          console.error("‚ùå Error en la petici√≥n:", error);
          failureCallback(error);
        });
    }

    function cargarEstadisticas(fecha) {
      fetch(
        `/calendario/api/estadisticas-mes?year=${fecha.getFullYear()}&month=${
          fecha.getMonth() + 1
        }`
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document.getElementById("total-ordenes").textContent =
              data.total_ordenes;
            document.getElementById("planes-programados").textContent =
              data.planes_programados;
            document.getElementById("ordenes-pendientes").textContent =
              data.ordenes_por_estado["Pendiente"] || 0;
            document.getElementById("ordenes-completadas").textContent =
              data.ordenes_por_estado["Completada"] || 0;
          } else {
            console.error("Error cargando estad√≠sticas:", data.error);
          }
        })
        .catch((error) => console.error("Error:", error));
    }

    function mostrarDetalleEvento(evento) {
      const modal = new bootstrap.Modal(document.getElementById("modalEvento"));
      const title = document.getElementById("modalEventoTitle");
      const body = document.getElementById("modalEventoBody");

      title.textContent = evento.title;

      let contenido = "";
      if (evento.extendedProps.tipo === "orden") {
        contenido = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Descripci√≥n:</strong><br>
                        ${evento.extendedProps.description}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado:</strong> <span class="badge bg-secondary">${
                          evento.extendedProps.estado
                        }</span><br>
                        <strong>Prioridad:</strong> ${
                          evento.extendedProps.prioridad
                        }<br>
                        <strong>Fecha:</strong> ${evento.start.toLocaleDateString()}
                    </div>
                </div>
            `;
      } else if (evento.extendedProps.tipo === "plan_futuro") {
        contenido = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Descripci√≥n:</strong><br>
                        ${evento.extendedProps.description}
                    </div>
                    <div class="col-md-6">
                        <strong>Activo:</strong> ${
                          evento.extendedProps.activo_nombre
                        }<br>
                        <strong>Frecuencia:</strong> ${
                          evento.extendedProps.frecuencia
                        }<br>
                        <strong>Fecha programada:</strong> ${evento.start.toLocaleDateString()}
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> Este es un mantenimiento preventivo programado. La orden se generar√° autom√°ticamente en esta fecha.
                </div>
            `;
      }

      body.innerHTML = contenido;
      modal.show();
    }

    // Funciones globales
    window.generarOrdenesHoy = function () {
      showConfirmModal({
        title: "Generar √ìrdenes de Trabajo",
        message: "¬øGenerar √≥rdenes para todos los planes vencidos hasta hoy?",
        confirmText: "S√≠, generar",
        cancelText: "Cancelar",
        type: "warning",
        onConfirm: function () {
          const hoy = new Date().toISOString().split("T")[0];

          fetch(`/calendario/api/generar-ordenes-fecha?fecha=${hoy}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const ordenes = data.ordenes_generadas || 0;
                mostrarMensaje(
                  `‚úÖ Se generaron ${ordenes} √≥rdenes correctamente`,
                  "success"
                );
                window.calendar.refetchEvents();
                cargarEstadisticas(window.calendar.getDate());
              } else {
                mostrarMensaje(`‚ùå Error: ${data.error}`, "danger");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              mostrarMensaje("‚ùå Error de conexi√≥n", "danger");
            });
        }
      });
    };

    window.actualizarCalendario = function () {
      window.calendar.refetchEvents();
      cargarEstadisticas(window.calendar.getDate());
      mostrarMensaje("üîÑ Calendario actualizado", "info");
    };

    function mostrarMensaje(mensaje, tipo = "info") {
      const alerta = document.createElement("div");
      alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
      alerta.style.cssText =
        "top: 20px; right: 20px; z-index: 1060; min-width: 300px;";
      alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
      document.body.appendChild(alerta);

      setTimeout(() => {
        if (alerta.parentNode) {
          alerta.parentNode.removeChild(alerta);
        }
      }, 5000);
    }
  });
</script>
{% endblock %}
