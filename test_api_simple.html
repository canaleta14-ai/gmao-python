<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Proveedores API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîß Test de Proveedores API</h2>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h4>1. Test API</h4>
                <button class="btn btn-primary" onclick="testAPI()">Probar /proveedores/api</button>
                <div id="api-result" class="mt-2"></div>
            </div>
            
            <div class="col-md-6">
                <h4>2. Test Select</h4>
                <button class="btn btn-success" onclick="testSelect()">Llenar Select</button>
                <select class="form-select mt-2" id="test-select">
                    <option value="">Seleccionar proveedor...</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h4>3. Logs</h4>
                <textarea id="logs" class="form-control" rows="15" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.value += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        async function testAPI() {
            log('üîÑ Iniciando test de API...');
            const resultDiv = document.getElementById('api-result');
            
            try {
                log('üì° Haciendo fetch a /proveedores/api...');
                const response = await fetch('/proveedores/api');
                log(`üì° Respuesta: Status ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Datos recibidos correctamente`);
                    log(`üìä Tipo de datos: ${typeof data}`);
                    log(`üìä Es array: ${Array.isArray(data)}`);
                    log(`üìä Longitud: ${data.length}`);
                    
                    data.forEach((p, i) => {
                        log(`üìù Proveedor ${i+1}: ${p.nombre} (ID: ${p.id}, Activo: ${p.activo}, Tipo activo: ${typeof p.activo})`);
                    });
                    
                    const activos = data.filter(p => p.activo === true);
                    log(`‚úÖ Proveedores activos encontrados: ${activos.length}`);
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ API OK</strong><br>
                            Total: ${data.length}<br>
                            Activos: ${activos.length}
                        </div>
                    `;
                } else {
                    log(`‚ùå Error en respuesta: ${response.status} ${response.statusText}`);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${response.status}</div>`;
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`);
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function testSelect() {
            log('üîÑ Iniciando test de select...');
            const select = document.getElementById('test-select');
            
            try {
                const response = await fetch('/proveedores/api');
                if (response.ok) {
                    const proveedores = await response.json();
                    log(`üì• Datos para select: ${proveedores.length} proveedores`);
                    
                    // Simular la funci√≥n llenarSelectProveedores
                    select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
                    
                    const proveedoresActivos = proveedores.filter(p => p.activo === true);
                    log(`üîç Proveedores activos filtrados: ${proveedoresActivos.length}`);
                    
                    if (proveedoresActivos.length === 0) {
                        select.innerHTML = '<option value="">‚ö†Ô∏è No hay proveedores activos</option>';
                        log('‚ö†Ô∏è No se encontraron proveedores activos');
                        return;
                    }
                    
                    proveedoresActivos.forEach((proveedor, index) => {
                        const option = document.createElement('option');
                        option.value = proveedor.id;
                        option.textContent = `${proveedor.nombre} (${proveedor.nif})`;
                        select.appendChild(option);
                        log(`‚ûï Opci√≥n agregada: ${option.textContent}`);
                    });
                    
                    log(`‚úÖ Select actualizado con ${proveedoresActivos.length} opciones`);
                } else {
                    log(`‚ùå Error al cargar para select: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Error en test de select: ${error.message}`);
            }
        }

        // Inicializaci√≥n
        log('üöÄ Test page cargada');
        log('üí° Haz clic en los botones para probar la funcionalidad');
    </script>
</body>
</html>