<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Autocompletado de Art√≠culos en Movimientos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="static/css/autocomplete.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .demo-data { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; }
        .status-indicator { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-search me-2"></i>Test: Autocompletado de Art√≠culos en Movimientos</h4>
            </div>
            <div class="card-body">
                <div class="status-indicator status-info">
                    <strong>Objetivo:</strong> Probar el autocompletado de art√≠culos con datos simulados
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <h5>Modal de Movimiento (Simulado):</h5>
                        <form id="formMovimiento">
                            <input type="hidden" id="movimiento-articulo-id">
                            
                            <div class="mb-3">
                                <label class="form-label">Art√≠culo</label>
                                <input type="text" class="form-control" id="movimiento-articulo-info" 
                                       placeholder="Buscar art√≠culo por c√≥digo o descripci√≥n...">
                                <div id="stock-info-display" class="text-muted small mt-1" style="display: none;"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="movimiento-tipo" class="form-label">Tipo de Movimiento</label>
                                <select class="form-select" id="movimiento-tipo">
                                    <option value="">Seleccionar...</option>
                                    <option value="entrada">Entrada</option>
                                    <option value="salida">Salida</option>
                                    <option value="ajuste">Ajuste</option>
                                    <option value="regularizacion">Regularizaci√≥n</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="movimiento-cantidad" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="movimiento-cantidad" min="1">
                                <div id="stock-alert" style="display: none;"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="movimiento-motivo" class="form-label">Motivo</label>
                                <select class="form-select" id="movimiento-motivo">
                                    <option value="">Seleccionar motivo...</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-md-4">
                        <h5>Datos de Prueba:</h5>
                        <div class="demo-data">
                            <strong>Art√≠culos disponibles:</strong><br>
                            ‚Ä¢ FLT-001: Filtro Aceite (Stock: 15)<br>
                            ‚Ä¢ BOM-002: Bomba Agua (Stock: 3)<br>
                            ‚Ä¢ COR-003: Correa Transmisi√≥n (Stock: 25)<br>
                            ‚Ä¢ ROD-004: Rodamiento (Stock: 8)<br>
                            ‚Ä¢ VAL-005: V√°lvula Presi√≥n (Stock: 2)
                        </div>
                        
                        <h6 class="mt-3">Controles de Prueba:</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="initializeArticuloAutoComplete()">
                                üîß Inicializar Autocompletado
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="simularSeleccionArticulo()">
                                üé≠ Simular Selecci√≥n
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="limpiarCampos()">
                                üßπ Limpiar Campos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/autocomplete.js"></script>
    <script>
        // Datos de prueba simulados
        const articulosSimulados = [
            { id: 1, codigo: 'FLT-001', descripcion: 'Filtro Aceite Motor', categoria: 'Filtros', stock_actual: 15, stock_minimo: 5 },
            { id: 2, codigo: 'BOM-002', descripcion: 'Bomba Agua Refrigeraci√≥n', categoria: 'Bombas', stock_actual: 3, stock_minimo: 2 },
            { id: 3, codigo: 'COR-003', descripcion: 'Correa Transmisi√≥n', categoria: 'Transmisi√≥n', stock_actual: 25, stock_minimo: 10 },
            { id: 4, codigo: 'ROD-004', descripcion: 'Rodamiento SKF 6205', categoria: 'Rodamientos', stock_actual: 8, stock_minimo: 5 },
            { id: 5, codigo: 'VAL-005', descripcion: 'V√°lvula Presi√≥n Hidr√°ulica', categoria: 'V√°lvulas', stock_actual: 2, stock_minimo: 1 },
            { id: 6, codigo: 'TUB-006', descripcion: 'Tubo Hidr√°ulico 1/2"', categoria: 'Tuber√≠as', stock_actual: 50, stock_minimo: 20 },
            { id: 7, codigo: 'SEL-007', descripcion: 'Sello Mec√°nico', categoria: 'Sellado', stock_actual: 12, stock_minimo: 8 }
        ];
        
        // Variable global para art√≠culo seleccionado actual
        let articuloSeleccionadoActual = null;
        
        // Simular API de b√∫squeda
        function buscarArticulos(query) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const resultados = articulosSimulados.filter(item => {
                        const q = query.toLowerCase();
                        return item.descripcion.toLowerCase().includes(q) || 
                               item.codigo.toLowerCase().includes(q) ||
                               item.categoria.toLowerCase().includes(q);
                    });
                    resolve(resultados);
                }, 300); // Simular delay de red
            });
        }
        
        // Inicializar autocompletado con datos simulados
        function initializeArticuloAutoComplete() {
            const input = document.getElementById('movimiento-articulo-info');
            if (!input || input.dataset.autocompleteInitialized) {
                console.log('‚ö†Ô∏è Input ya inicializado o no encontrado');
                return;
            }
            
            console.log('üîß Inicializando autocompletado...');
            
            const autocompleteInstance = new AutoComplete({
                element: input,
                localData: articulosSimulados, // Usar datos locales para la demo
                displayKey: item => `${item.codigo} - ${item.descripcion} (Stock: ${item.stock_actual})`,
                valueKey: 'id',
                placeholder: 'Buscar art√≠culo por c√≥digo o descripci√≥n...',
                minChars: 1,
                maxResults: 10,
                noResultsText: 'No se encontraron art√≠culos',
                customFilter: (item, query) => {
                    const q = query.toLowerCase();
                    return item.descripcion.toLowerCase().includes(q) || 
                           item.codigo.toLowerCase().includes(q) ||
                           item.categoria.toLowerCase().includes(q);
                },
                onSelect: (item) => {
                    console.log('‚úÖ Art√≠culo seleccionado:', item);
                    articuloSeleccionadoActual = item;
                    document.getElementById('movimiento-articulo-id').value = item.id;
                    
                    // Mostrar informaci√≥n de stock
                    const stockInfo = document.getElementById('stock-info-display');
                    if (stockInfo) {
                        stockInfo.innerHTML = `
                            <strong>Stock:</strong> ${item.stock_actual} | 
                            <strong>M√≠nimo:</strong> ${item.stock_minimo} | 
                            <strong>Categor√≠a:</strong> ${item.categoria}
                        `;
                        stockInfo.style.display = 'block';
                    }
                    
                    // Validar si el tipo actual es salida
                    const tipoMovimiento = document.getElementById('movimiento-tipo');
                    if (tipoMovimiento && tipoMovimiento.value === 'salida') {
                        validarStockParaSalida(item);
                    }
                },
                onInput: (value) => {
                    if (value.length < 2) {
                        document.getElementById('movimiento-articulo-id').value = '';
                        articuloSeleccionadoActual = null;
                        const stockInfo = document.getElementById('stock-info-display');
                        if (stockInfo) stockInfo.style.display = 'none';
                        const stockAlert = document.getElementById('stock-alert');
                        if (stockAlert) stockAlert.style.display = 'none';
                    }
                }
            });
            
            input.dataset.autocompleteInitialized = 'true';
            console.log('‚úÖ Autocompletado inicializado correctamente');
        }
        
        // Validar stock para movimientos de salida
        function validarStockParaSalida(articulo) {
            const cantidadInput = document.getElementById('movimiento-cantidad');
            const stockAlert = document.getElementById('stock-alert');
            
            if (!cantidadInput || !stockAlert) return;
            
            const validarCantidad = () => {
                const cantidad = parseInt(cantidadInput.value) || 0;
                
                if (cantidad <= 0) {
                    stockAlert.style.display = 'none';
                    return;
                }
                
                if (cantidad > articulo.stock_actual) {
                    stockAlert.innerHTML = `
                        <div class="alert alert-danger alert-sm mt-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>‚ö†Ô∏è Stock Insuficiente:</strong> Cantidad solicitada (${cantidad}) supera el stock disponible (${articulo.stock_actual})
                        </div>
                    `;
                    stockAlert.style.display = 'block';
                } else if ((articulo.stock_actual - cantidad) < articulo.stock_minimo) {
                    stockAlert.innerHTML = `
                        <div class="alert alert-warning alert-sm mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>‚ÑπÔ∏è Advertencia:</strong> Esta salida dejar√° el stock (${articulo.stock_actual - cantidad}) por debajo del m√≠nimo recomendado (${articulo.stock_minimo})
                        </div>
                    `;
                    stockAlert.style.display = 'block';
                } else {
                    stockAlert.innerHTML = `
                        <div class="alert alert-success alert-sm mt-2">
                            <i class="bi bi-check-circle me-1"></i>
                            <strong>‚úÖ OK:</strong> Stock suficiente. Quedar√°n ${articulo.stock_actual - cantidad} unidades.
                        </div>
                    `;
                    stockAlert.style.display = 'block';
                }
            };
            
            // Remover listener anterior si existe
            cantidadInput.removeEventListener('input', cantidadInput._stockValidator);
            
            // Agregar nuevo listener
            cantidadInput._stockValidator = validarCantidad;
            cantidadInput.addEventListener('input', validarCantidad);
            
            // Validar inmediatamente si ya hay valor
            if (cantidadInput.value) {
                validarCantidad();
            }
        }
        
        // Funciones de control
        function simularSeleccionArticulo() {
            const input = document.getElementById('movimiento-articulo-info');
            const articulo = articulosSimulados[0]; // Filtro de aceite
            
            if (input.dataset.autocompleteInitialized) {
                input.value = `${articulo.codigo} - ${articulo.descripcion} (Stock: ${articulo.stock_actual})`;
                // Simular selecci√≥n
                document.getElementById('movimiento-articulo-id').value = articulo.id;
                articuloSeleccionadoActual = articulo;
                
                const stockInfo = document.getElementById('stock-info-display');
                stockInfo.innerHTML = `<strong>Stock:</strong> ${articulo.stock_actual} | <strong>M√≠nimo:</strong> ${articulo.stock_minimo} | <strong>Categor√≠a:</strong> ${articulo.categoria}`;
                stockInfo.style.display = 'block';
                
                console.log('üé≠ Art√≠culo simulado seleccionado:', articulo);
            } else {
                console.warn('Primero inicializa el autocompletado');
                // Crear mensaje bonito en lugar de alert
                const mensaje = document.createElement('div');
                mensaje.className = 'alert alert-warning alert-dismissible fade show position-fixed';
                mensaje.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
                mensaje.innerHTML = `
                    <strong>Advertencia</strong><br>
                    Primero inicializa el autocompletado
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(mensaje);
                
                // Auto-remover despu√©s de 5 segundos
                setTimeout(() => {
                    if (mensaje.parentNode) {
                        mensaje.remove();
                    }
                }, 5000);
            }
        }
        
        function limpiarCampos() {
            document.getElementById('formMovimiento').reset();
            document.getElementById('movimiento-articulo-id').value = '';
            document.getElementById('stock-info-display').style.display = 'none';
            document.getElementById('stock-alert').style.display = 'none';
            articuloSeleccionadoActual = null;
            console.log('üßπ Campos limpiados');
        }
        
        // Listener para cambio de tipo de movimiento
        document.addEventListener('DOMContentLoaded', function() {
            const tipoSelect = document.getElementById('movimiento-tipo');
            const cantidadInput = document.getElementById('movimiento-cantidad');
            
            tipoSelect.addEventListener('change', function() {
                const stockAlert = document.getElementById('stock-alert');
                
                if (this.value === 'salida' && articuloSeleccionadoActual) {
                    validarStockParaSalida(articuloSeleccionadoActual);
                    if (cantidadInput.value) {
                        cantidadInput.dispatchEvent(new Event('input'));
                    }
                } else {
                    stockAlert.style.display = 'none';
                }
            });
            
            console.log('üöÄ Test de autocompletado cargado');
            console.log('üìù Instrucciones:');
            console.log('1. Haz clic en "Inicializar Autocompletado"');
            console.log('2. Escribe en el campo art√≠culo (ej: "filtro", "FLT", "bomba")');
            console.log('3. Selecciona un art√≠culo de las sugerencias');
            console.log('4. Cambia el tipo a "Salida" y prueba con diferentes cantidades');
        });
    </script>
</body>
</html>